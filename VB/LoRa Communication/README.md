## LoRa Communication

In this folder all documentation and scripts related to LoRa communication of the Vibration Sensor can be found.

### Conversion

The Vibration Sensor communicates over LoRaWAN using a binary protocol. Usually the binary protocol is converted at the LoRa network server to an easier to handle format: JSON.

- encoding: from JSON to a binary string for to the Vibration Sensor
- decoding: from a binary string from the Vibration Sensor to JSON

#### Encoder / decoder

This folder contains Javascript files can help with the conversion in for example the LoRa network server. The scripts are known to be compatible with the following network servers:

- [ChirpStack](https://www.chirpstack.io/)
- [The Things Network](https://www.thethingsnetwork.org/)


The encoder/decoder script names are postfixed with version information: 

	[encoder/decoder]_[type]_doc-[doc]_rev-[rev].js

- **type**: the sensor type abbreviation
- **doc**: the communication protocol document version
- **rev**: the revision number of improvements of the scripts

#### Conversion examples

The examles below are generated using the example Javascript files in the example folder using [nodejs](https://nodejs.org/) (a Linux application to execute Javascript files).

##### Encoding

Generated by:
```
nodejs examples/encoder-vb-examples.js
```
###### Base config message (EU868)
JSON:
```json
{
    "header": {
        "message_type": "base_configuration",
        "protocol_version": 2
    },
    "switch_mask": {
        "enable_confirmed_event_message": true,
        "enable_confirmed_data_message": false,
        "allow_deactivation": true
    },
    "communication_max_retries": 3,
    "unconfirmed_repeat": 1,
    "periodic_message_random_delay_seconds": 60,
    "status_message_interval_seconds": 86400,
    "status_message_confirmed_interval": 1,
    "lora_failure_holdoff_count": 2,
    "lora_system_recover_count": 1,
    "lorawan_fsb_mask": [
        "0x0000",
        "0x0000",
        "0x0000",
        "0x0000",
        "0x0000"
    ]
}
```
Bytestring (hexidecimal):
```
250903013ca00501020100000000000000000000d513
```
Bytestring (base64):
```
JQkDATygBQECAQAAAAAAAAAAAADVEw==
```
###### Base config message (US915)
JSON:
```json
{
    "header": {
        "message_type": "base_configuration",
        "protocol_version": 2
    },
    "switch_mask": {
        "enable_confirmed_event_message": true,
        "enable_confirmed_data_message": false,
        "allow_deactivation": true
    },
    "communication_max_retries": 3,
    "unconfirmed_repeat": 1,
    "periodic_message_random_delay_seconds": 60,
    "status_message_interval_seconds": 86400,
    "status_message_confirmed_interval": 1,
    "lora_failure_holdoff_count": 2,
    "lora_system_recover_count": 1,
    "lorawan_fsb_mask": [
        "0x00FF",
        "0x0000",
        "0x0000",
        "0x0000",
        "0x0000"
    ]
}
```
Bytestring (hexidecimal):
```
250903013ca005010201ff000000000000000000c1c4
```
Bytestring (base64):
```
JQkDATygBQECAf8AAAAAAAAAAADBxA==
```
###### Sensor config message (default)
JSON:
```json
{
    "header": {
        "message_type": "sensor_configuration",
        "protocol_version": 2
    },
    "device_type": "vb",
    "measurement_interval_seconds": 900,
    "periodic_event_message_interval": 16,
    "frequency_range": {
        "rms_velocity": "range_2",
        "peak_acceleration": "range_2"
    },
    "events": [
        {
            "mode": "off",
            "mode_value": 0
        },
        {
            "mode": "off",
            "mode_value": 0
        },
        {
            "mode": "off",
            "mode_value": 0
        },
        {
            "mode": "off",
            "mode_value": 0
        },
        {
            "mode": "off",
            "mode_value": 0
        },
        {
            "mode": "off",
            "mode_value": 0
        }
    ]
}
```
Bytestring (hexidecimal):
```
2606840310000300000000000000000000000000000000000079cd
```
Bytestring (base64):
```
JgaEAxAAAwAAAAAAAAAAAAAAAAAAAAAAAHnN
```
###### Sensor config message (alternative)
JSON:
```json
{
    "header": {
        "message_type": "sensor_configuration",
        "protocol_version": 2
    },
    "device_type": "vb",
    "measurement_interval_seconds": 3600,
    "periodic_event_message_interval": 1,
    "frequency_range": {
        "rms_velocity": "range_2",
        "peak_acceleration": "range_1"
    },
    "events": [
        {
            "mode": "rms_velocity_x",
            "mode_value": 0.05
        },
        {
            "mode": "rms_velocity_y",
            "mode_value": 99.99
        },
        {
            "mode": "peak_acceleration_z",
            "mode_value": 0.01
        },
        {
            "mode": "peak_acceleration_x",
            "mode_value": 200
        },
        {
            "mode": "off",
            "mode_value": 0
        },
        {
            "mode": "off",
            "mode_value": 0
        }
    ]
}
```
Bytestring (hexidecimal):
```
2606100e010001010500030f2706010002204e0000000000001e69
```
Bytestring (base64):
```
JgYQDgEAAQEFAAMPJwYBAAIgTgAAAAAAAB5p
```
###### Sensor data config message (default)
JSON:
```json
{
    "header": {
        "message_type": "sensor_data_configuration",
        "protocol_version": 2
    },
    "device_type": "vb",
    "calculation_trigger": {
        "on_event": false,
        "on_threshold": false,
        "on_button_press": false
    },
    "calculation_interval": 0,
    "fragment_message_interval": 14400,
    "threshold_window": 10,
    "trigger_thresholds": [
        {
            "unit": "velocity",
            "frequency": 0,
            "magnitude": 0
        },
        {
            "unit": "velocity",
            "frequency": 0,
            "magnitude": 0
        },
        {
            "unit": "velocity",
            "frequency": 0,
            "magnitude": 0
        },
        {
            "unit": "velocity",
            "frequency": 0,
            "magnitude": 0
        },
        {
            "unit": "velocity",
            "frequency": 0,
            "magnitude": 0
        }
    ],
    "selection": {
        "axis": "z",
        "resolution": "low_res",
        "enable_hanning_window": true
    },
    "frequency": {
        "span": {
            "velocity": {
                "start": 3,
                "stop": 126
            },
            "acceleration": {
                "start": 61,
                "stop": 4096
            }
        },
        "resolution": {
            "velocity": 1,
            "acceleration": 2
        }
    },
    "scale": {
        "velocity": 4,
        "acceleration": 40
    }
}
```
Bytestring (hexidecimal):
```
270600000040380500000000000000000000000000000000000000000a03007e003d000010010224345128
```
Bytestring (base64):
```
JwYAAABAOAUAAAAAAAAAAAAAAAAAAAAAAAAAAAoDAH4APQAAEAECJDRRKA==
```
###### Sensor data config message (alternative)
JSON:
```json
{
    "header": {
        "message_type": "sensor_data_configuration",
        "protocol_version": 2
    },
    "device_type": "vb",
    "calculation_trigger": {
        "on_event": false,
        "on_threshold": true,
        "on_button_press": true
    },
    "calculation_interval": 0,
    "fragment_message_interval": 14400,
    "threshold_window": 10,
    "trigger_thresholds": [
        {
            "unit": "velocity",
            "frequency": 100,
            "magnitude": 200
        },
        {
            "unit": "acceleration",
            "frequency": 100,
            "magnitude": 67.89
        },
        {
            "unit": "acceleration",
            "frequency": 4000,
            "magnitude": 123.45
        },
        {
            "unit": "velocity",
            "frequency": 0,
            "magnitude": 0
        },
        {
            "unit": "velocity",
            "frequency": 0,
            "magnitude": 0
        }
    ],
    "selection": {
        "axis": "z",
        "resolution": "low_res",
        "enable_hanning_window": true
    },
    "frequency": {
        "span": {
            "velocity": {
                "start": 3,
                "stop": 126
            },
            "acceleration": {
                "start": 61,
                "stop": 4096
            }
        },
        "resolution": {
            "velocity": 1,
            "acceleration": 2
        }
    },
    "scale": {
        "velocity": 4,
        "acceleration": 40
    }
}
```
Bytestring (hexidecimal):
```
2706060000403805c800204ec900851a411f393000000000000000000a03007e003d0000100102243425ee
```
Bytestring (base64):
```
JwYGAABAOAXIACBOyQCFGkEfOTAAAAAAAAAAAAoDAH4APQAAEAECJDQl7g==
```
##### Decoding

Generated by:
```
nodejs examples/decoder-vb-examples.js
```

###### Boot message
Bytestring (hexidecimal):
```
20050df0ad8b34120c030344332211ffffffffff060102030405dec0edfebbaa55440a04040807060504030201ee
```
JSON:
```json
{
    "header": {
        "protocol_version": 2,
        "message_type": "boot"
    },
    "boot": {
        "base": {
            "device_type": "ld",
            "version_hash": "0x8BADF00D",
            "config_crc": "0x1234",
            "reset_flags": "0x0C",
            "reboot_counter": 3,
            "reboot_info": "assert (caller: 0x11223344; value: -1)",
            "bist": "0xFF"
        },
        "sensor": {
            "device_type": "vb",
            "device_id": "1-0084148994",
            "version_hash": "0xFEEDC0DE",
            "config_crc": "0xAABB",
            "data_config_crc": "0x4455",
            "reset_flags": "0x0A",
            "reboot_counter": 4,
            "reboot_info": "application (0x05060708)",
            "bist": "0xEE"
        }
    }
}
```
###### Activated message
Bytestring (hexidecimal):
```
21060801020304
```
JSON:
```json
{
    "header": {
        "protocol_version": 2,
        "message_type": "activated"
    },
    "activated": {
        "sensor": {
            "device_type": "vb",
            "device_id": "8-0067305985"
        }
    }
}
```
###### Deactivated message
Bytestring (hexidecimal):
```
220200
```
JSON:
```json
{
    "header": {
        "protocol_version": 2,
        "message_type": "deactivated"
    },
    "deactivated": {
        "reason": "activation_sensor_comm_fail"
    }
}
```
###### Device status message (pattern)
Bytestring (hexidecimal):
```
24edfe0b000c000d00151617020304050606dec037130107
```
JSON:
```json
{
    "header": {
        "protocol_version": 2,
        "message_type": "device_status"
    },
    "device_status": {
        "base": {
            "config_crc": "0xFEED",
            "battery_voltage": {
                "low": 0.011,
                "high": 0.012,
                "settle": 0.013
            },
            "temperature": {
                "min": 21,
                "max": 22,
                "avg": 23
            },
            "lvds_error_counter": 2,
            "lora_tx_counter": 3,
            "avg_rssi": -4,
            "avg_snr": 5,
            "bist": "0x06"
        },
        "sensor": {
            "device_type": "vb",
            "config_crc": "0xC0DE",
            "data_config_crc": "0x1337",
            "event_counter": 1,
            "bist": "0x07"
        }
    }
}
```
###### Application event message
Bytestring (hexidecimal):
```
23010100d20488130200d30487130300d40486130400d50485130500d60484130600d704831361f0d204401f15
```
JSON:
```json
{
    "header": {
        "protocol_version": 2,
        "message_type": "sensor_event"
    },
    "sensor_event": {
        "trigger": "button",
        "rms_velocity": {
            "x": {
                "min": 0.01,
                "max": 12.34,
                "avg": 50
            },
            "y": {
                "min": 0.02,
                "max": 12.35,
                "avg": 49.99
            },
            "z": {
                "min": 0.03,
                "max": 12.36,
                "avg": 49.98
            }
        },
        "acceleration": {
            "x": {
                "min": 0.04,
                "max": 12.37,
                "avg": 49.97
            },
            "y": {
                "min": 0.05,
                "max": 12.38,
                "avg": 49.96
            },
            "z": {
                "min": 0.06,
                "max": 12.39,
                "avg": 49.95
            }
        },
        "temperature": {
            "min": -39.99,
            "max": 12.34,
            "avg": 80
        },
        "condition_0": 1,
        "condition_1": 0,
        "condition_2": 1,
        "condition_3": 0,
        "condition_4": 1,
        "condition_5": 0
    }
}
```
###### Application data message
Bytestring (hexidecimal):
```
282bf94506020102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728
```
JSON:
```json
{
    "header": {
        "protocol_version": 2,
        "message_type": "sensor_data"
    },
    "sensor_data": {
        "config": {
            "frame_number": 43,
            "sequence_number": 1,
            "axis": "z",
            "unit": "acceleration",
            "scale": 15,
            "start_frequency": 200,
            "spectral_line_frequency": 2
        },
        "raw": [
            1,
            2,
            3,
            4,
            5,
            6,
            7,
            8,
            9,
            10,
            11,
            12,
            13,
            14,
            15,
            16,
            17,
            18,
            19,
            20,
            21,
            22,
            23,
            24,
            25,
            26,
            27,
            28,
            29,
            30,
            31,
            32,
            33,
            34,
            35,
            36,
            37,
            38,
            39,
            40
        ],
        "frequency": [
            5924.536800000001,
            5927.792040000001,
            5931.047280000001,
            5934.302520000001,
            5937.557760000001,
            5940.813000000001,
            5944.0682400000005,
            5947.323480000001,
            5950.57872,
            5953.833960000001,
            5957.0892,
            5960.344440000001,
            5963.599680000001,
            5966.854920000001,
            5970.110160000001,
            5973.365400000001,
            5976.620640000001,
            5979.8758800000005,
            5983.131120000001,
            5986.38636,
            5989.641600000001,
            5992.89684,
            5996.152080000001,
            5999.407320000001,
            6002.662560000001,
            6005.917800000001,
            6009.173040000001,
            6012.428280000001,
            6015.6835200000005,
            6018.938760000001,
            6022.194,
            6025.449240000001,
            6028.70448,
            6031.959720000001,
            6035.214960000001,
            6038.470200000001,
            6041.725440000001,
            6044.980680000001,
            6048.235920000001,
            6051.4911600000005
        ],
        "magnitude": [
            0.058823529411764705,
            0.11764705882352941,
            0.17647058823529413,
            0.23529411764705882,
            0.29411764705882354,
            0.35294117647058826,
            0.4117647058823529,
            0.47058823529411764,
            0.5294117647058824,
            0.5882352941176471,
            0.6470588235294118,
            0.7058823529411765,
            0.7647058823529411,
            0.8235294117647058,
            0.8823529411764706,
            0.9411764705882353,
            1,
            1.0588235294117647,
            1.1176470588235294,
            1.1764705882352942,
            1.2352941176470589,
            1.2941176470588236,
            1.3529411764705883,
            1.411764705882353,
            1.4705882352941178,
            1.5294117647058822,
            1.588235294117647,
            1.6470588235294117,
            1.7058823529411764,
            1.7647058823529411,
            1.8235294117647058,
            1.8823529411764706,
            1.9411764705882353,
            2,
            2.0588235294117645,
            2.1176470588235294,
            2.176470588235294,
            2.235294117647059,
            2.2941176470588234,
            2.3529411764705883
        ]
    }
}
```