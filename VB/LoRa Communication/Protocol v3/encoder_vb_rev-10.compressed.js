"undefined"!=typeof module&&(module.exports={encodeDownlink:encodeDownlink,Encode:Encode,Encoder:Encoder,encode_header:encode_header,encode_header_v3:encode_header_v3,encode_events_mode:encode_events_mode,encode_base_config:encode_base_config,encode_vb_sensor_config:encode_vb_sensor_config,encode_vb_sensor_data_config_v1:encode_vb_sensor_data_config_v1,encode_vb_sensor_data_config_v2:encode_vb_sensor_data_config_v2,encode_vb_sensor_data_config_v3:encode_vb_sensor_data_config_v3,encode_calculation_trigger:encode_calculation_trigger,encode_fft_trigger_threshold:encode_fft_trigger_threshold,encode_fft_selection:encode_fft_selection,encode_frequency_range:encode_frequency_range,encode_base_config_switch:encode_base_config_switch,encode_device_type:encode_device_type,encode_uint32:encode_uint32,encode_int32:encode_int32,encode_uint16:encode_uint16,encode_int16:encode_int16,encode_uint8:encode_uint8,encode_int8:encode_int8,encode_sci_6:encode_sci_6,calc_crc:calc_crc,encode_status_msg_delay_interval_v3:encode_status_msg_delay_interval_v3,encode_base_config_v3:encode_base_config_v3,encode_base_config_switch_v3:encode_base_config_switch_v3,encode_region_config_v3:encode_region_config_v3,encode_channel_plan_v3:encode_channel_plan_v3,encode_vb_sensor_config_v3:encode_vb_sensor_config_v3,encode_vb_sensor_conditions_configuration_v3:encode_vb_sensor_conditions_configuration_v3,encode_event_condition_v3:encode_event_condition_v3,encode_sensor_config_switch_mask_v3:encode_sensor_config_switch_mask_v3});var mask_byte=255;function _encode(e){e=e.data;var n={},o=[];n.bytes=o,n.fPort=15;var c,_=0;for(c in e)void 0!==e[c].protocol_version&&(_=e[c].protocol_version);switch(_){case 1:case 2:switch(n.fPort=15,e.header.message_type){case"base_configuration":encode_header(o,5,e.header.protocol_version),encode_base_config(o,e),encode_uint16(o,calc_crc(o.slice(1)));break;case"sensor_configuration":if("vb"!==e.device_type)throw new Error("Invalid device type!");encode_header(o,6,e.header.protocol_version),encode_vb_sensor_config(o,e),encode_uint16(o,calc_crc(o.slice(1)));break;case"sensor_data_configuration":if("vb"!==e.device_type)throw new Error("Invalid device type!");switch(encode_header(o,7,e.header.protocol_version),e.header.protocol_version){case 1:encode_vb_sensor_data_config_v1(o,e);break;case 2:encode_vb_sensor_data_config_v2(o,e);break;default:throw new Error("Protocol version is not supported!")}encode_uint16(o,calc_crc(o.slice(1)));break;default:throw new Error("Invalid message type!")}break;case 3:var t=Object.keys(e)[0],i=e[t];switch(t){case"config_update_req":switch(n.fPort=7,i.config_type){case"base":encode_header_v3(o,i),void 0!==i.payload&&(encode_uint32(o,i.tag),encode_base_config_v3(o,i.payload));break;case"region":encode_header_v3(o,i),void 0!==i.payload&&(encode_uint32(o,i.tag),encode_region_config_v3(o,i.payload));break;case"sensor":encode_header_v3(o,i),void 0!==i.payload&&(encode_uint32(o,i.tag),encode_vb_sensor_config_v3(o,i.payload));break;case"sensor_data":encode_header_v3(o,i),void 0!==i.payload&&(encode_uint32(o,i.tag),encode_vb_sensor_data_config_v3(o,i.payload));break;case"sensor_conditions":encode_header_v3(o,i),void 0!==i.payload&&(encode_uint32(o,i.tag),encode_vb_sensor_conditions_configuration_v3(o,i.payload));break;default:throw n.fPort=0,new Error("Invalid config type!")}break;case"calib_update_req":n.fPort=8;break;default:throw new Error("Unknown request type")}break;default:throw new Error("Protocol version is not supported!")}return n}function encodeDownlink(e){try{return _encode(e)}catch(e){return{errors:[e.message]}}}function Encode(e,n){return _encode({data:n,fPort:e}).bytes}function Encoder(e,n){return _encode({data:e,fPort:n}).bytes}function encode_base_config(e,n){var o=0;if(void 0!==n.number_of_unconfirmed_messages)o=n.number_of_unconfirmed_messages;else{if(void 0===n.unconfirmed_repeat)throw new Error("Missing number_of_unconfirmed_messages OR unconfirmed_repeat parameter");o=n.unconfirmed_repeat}if(void 0===n.bypass_sanity_check||0==n.bypass_sanity_check){if(o<1||5<o)throw new Error("number_of_unconfirmed_messages is outside of specification: "+n.number_of_unconfirmed_messages);if(n.communication_max_retries<1)throw new Error("communication_max_retries is outside specification: "+n.communication_max_retries);if(n.status_message_interval_seconds<60||604800<n.status_message_interval_seconds)throw new Error("status_message_interval_seconds is outside specification: "+n.status_message_interval_seconds);if(n.lora_failure_holdoff_count<0||255<n.lora_failure_holdoff_count)throw new Error("lora_failure_holdoff_count is outside specification: "+n.lora_failure_holdoff_count);if(n.lora_system_recover_count<0||255<n.lora_system_recover_count)throw new Error("lora_system_recover_count is outside specification: "+n.lora_system_recover_count)}encode_base_config_switch(e,n.switch_mask),encode_uint8(e,n.communication_max_retries),encode_uint8(e,o),encode_uint8(e,n.periodic_message_random_delay_seconds),encode_uint16(e,n.status_message_interval_seconds/60),encode_uint8(e,n.status_message_confirmed_interval),encode_uint8(e,n.lora_failure_holdoff_count),encode_uint8(e,n.lora_system_recover_count),encode_uint16(e,n.lorawan_fsb_mask[0]),encode_uint16(e,n.lorawan_fsb_mask[1]),encode_uint16(e,n.lorawan_fsb_mask[2]),encode_uint16(e,n.lorawan_fsb_mask[3]),encode_uint16(e,n.lorawan_fsb_mask[4])}function encode_base_config_v3(e,n){if(void 0!==n){if(n.periodic_message_random_delay_seconds<0||31<n.periodic_message_random_delay_seconds)throw new Error("periodic_message_random_delay_seconds is outside of specification: "+n.periodic_message_random_delay_seconds);encode_base_config_switch_v3(e,n.switch_mask),encode_status_msg_delay_interval_v3(e,n.periodic_message_random_delay_seconds,n.status_message_interval)}}function encode_vb_sensor_config_v3(e,n){if(void 0!==n){if("vb"!=n.device_type)throw new Error("Invalid device type!");if(encode_device_type(e,n.device_type),encode_sensor_config_switch_mask_v3(e,n.switch_mask),0==n.measurement_interval_minutes||240<n.measurement_interval_minutes)throw new Error("measurement_interval_minutes outside of specification: "+n.measurement_interval_minutes);if(encode_uint8(e,n.measurement_interval_minutes),10080<n.periodic_event_message_interval||n.periodic_event_message_interval<0)throw new Error("periodic_event_message_interval outside of specification: "+n.periodic_event_message_interval);encode_uint16(e,n.periodic_event_message_interval),encode_frequency_range(e,n.frequency_range.velocity,n.frequency_range.acceleration)}}function encode_vb_sensor_config(e,n){encode_device_type(e,n.device_type),encode_uint16(e,n.measurement_interval_seconds),encode_uint16(e,n.periodic_event_message_interval),encode_frequency_range(e,n.frequency_range.rms_velocity,n.frequency_range.peak_acceleration);for(var o=0,o=0;o<6;o++)encode_events_mode(e,n.events[o].mode),"off"!=n.events[o].mode?encode_int16(e,n.events[o].mode_value/.01):encode_int16(e,0)}function encode_vb_sensor_data_config_v1(e,n){if(encode_device_type(e,n.device_type),encode_calculation_trigger(e,n.calculation_trigger),encode_uint16(e,n.calculation_interval),encode_uint16(e,n.fragment_message_interval),n.threshold_window%2)throw new Error("threshold_window must be multiple of 2");for(encode_uint8(e,n.threshold_window/2),idx=0;idx<5;idx++)encode_fft_trigger_threshold(e,n.trigger_thresholds[idx].unit,n.trigger_thresholds[idx].frequency,n.trigger_thresholds[idx].magnitude);if(encode_fft_selection(e,n.selection),encode_uint16(e,n.frequency.span.velocity.start),encode_uint16(e,n.frequency.span.velocity.stop),encode_uint16(e,n.frequency.span.acceleration.start),encode_uint16(e,n.frequency.span.acceleration.stop),encode_uint8(e,n.frequency.resolution.velocity),encode_uint8(e,n.frequency.resolution.acceleration),n.scale.velocity%4)throw new Error("scale.velocity must be multiple of 4");if(encode_uint8(e,n.scale.velocity/4),n.scale.acceleration%4)throw new Error("scale.acceleration must be multiple of 4");encode_uint8(e,n.scale.acceleration/4)}function encode_vb_sensor_data_config_v2(e,n){if(encode_device_type(e,n.device_type),encode_calculation_trigger(e,n.calculation_trigger),encode_uint16(e,n.calculation_interval),encode_uint16(e,n.fragment_message_interval),n.threshold_window%2)throw new Error("threshold_window must be multiple of 2");for(encode_uint8(e,n.threshold_window/2),idx=0;idx<5;idx++)encode_fft_trigger_threshold(e,n.trigger_thresholds[idx].unit,n.trigger_thresholds[idx].frequency,n.trigger_thresholds[idx].magnitude);encode_fft_selection(e,n.selection),validate_frequency_span(n.frequency.span.velocity,n.frequency.resolution.velocity,"velocity"),validate_frequency_span(n.frequency.span.acceleration,n.frequency.resolution.acceleration,"acceleration"),encode_uint16(e,n.frequency.span.velocity.start),encode_uint16(e,n.frequency.span.velocity.stop),encode_uint16(e,n.frequency.span.acceleration.start),encode_uint16(e,n.frequency.span.acceleration.stop),encode_uint8(e,n.frequency.resolution.velocity),encode_uint8(e,n.frequency.resolution.acceleration),encode_sci_6(e,n.scale.velocity),encode_sci_6(e,n.scale.acceleration)}function encode_vb_sensor_data_config_v3(e,n){if(void 0!==n){if("vb"!=n.device_type)throw new Error("Invalid device type!");if(encode_device_type(e,n.device_type),encode_calculation_trigger(e,n.calculation_trigger),encode_uint16(e,n.calculation_interval),encode_uint16(e,n.fragment_message_interval),n.threshold_window%2)throw new Error("threshold_window must be multiple of 2");for(encode_uint8(e,n.threshold_window/2),idx=0;idx<5;idx++)encode_fft_trigger_threshold(e,n.trigger_thresholds[idx].unit,n.trigger_thresholds[idx].frequency,n.trigger_thresholds[idx].magnitude);encode_fft_selection(e,n.selection),validate_frequency_span(n.frequency.span.velocity,n.frequency.resolution.velocity,"velocity"),validate_frequency_span(n.frequency.span.acceleration,n.frequency.resolution.acceleration,"acceleration"),encode_uint16(e,n.frequency.span.velocity.start),encode_uint16(e,n.frequency.span.velocity.stop),encode_uint16(e,n.frequency.span.acceleration.start),encode_uint16(e,n.frequency.span.acceleration.stop),encode_uint8(e,n.frequency.resolution.velocity),encode_uint8(e,n.frequency.resolution.acceleration)}}function encode_region_config_v3(e,n){if(void 0!==n){if(encode_channel_plan_v3(e,n.channel_plan),7<n.join_trials.holdoff_steps)throw new Error("Hold off steps too large");if(burst_min1=n.join_trials.burst_count-1&255,31<burst_min1)throw new Error("Burst range 1..32");if(join_trials=255&n.join_trials.holdoff_hours_max,join_trials|=n.join_trials.holdoff_steps<<8,join_trials|=burst_min1<<11,encode_uint16(e,join_trials),disable_switch=4095&n.disable_switch.frequency_bands,0==(4095^disable_switch))throw new Error("Not disable all bands");disable_switch|=n.disable_switch.dwell_time?4096:0,encode_uint16(e,disable_switch),encode_uint8(e,15&n.rx1_delay),adr=n.adr.mode,adr|=(7&n.adr.ack_limit_exp)<<2,adr|=(7&n.adr.ack_delay_exp)<<5,encode_uint8(e,adr),encode_int8(e,n.max_tx_power)}}function encode_vb_sensor_conditions_configuration_v3(e,n){if(void 0!==n){if("vb"!=n.device_type)throw new Error("Invalid device type!");encode_device_type(e,n.device_type);for(var o=0,o=0;o<5;o++){if("rms_velocity_x"==n.event_conditions[o].mode||"rms_velocity_y"==n.event_conditions[o].mode||"rms_velocity_z"==n.event_conditions[o].mode){if(200<=n.event_conditions[o].mode_value)throw new Error("mode_value is outside of specification: "+n.event_conditions[o].mode_value)}else if(("peak_acceleration_x"==n.event_conditions[o].mode||"peak_acceleration_y"==n.event_conditions[o].mode||"peak_acceleration_z"==n.event_conditions[o].mode)&&150<=n.event_conditions[o].mode_value)throw new Error("mode_value is outside of specification: "+n.event_conditions[o].mode_value);encode_event_condition_v3(e,n.event_conditions[o])}}}function encode_header(e,n,o){var c=0;c+=15&n,c+=(15&o)<<4,e.push(c)}function encode_header_v3(e,n){var o=0;o+=15&lookup_config_type(n.config_type),encode_uint8(e,o+=(15&n.protocol_version)<<4)}function encode_device_type(e,n){switch(n){case"ts":encode_uint8(e,1);break;case"vs-qt":encode_uint8(e,2);break;case"vs-mt":encode_uint8(e,3);break;case"tt":encode_uint8(e,4);break;case"ld":encode_uint8(e,5);break;case"vb":encode_uint8(e,6);break;default:encode_uint8(e,0)}}function encode_event_condition_v3(e,n){var o=0,c=[];encode_events_mode(c,n.mode),o|=c[0]<<12,encode_uint16(e,10*n.mode_value|o)}function encode_events_mode(e,n){switch(n){case"rms_velocity_x":encode_uint8(e,1);break;case"peak_acceleration_x":encode_uint8(e,2);break;case"rms_velocity_y":encode_uint8(e,3);break;case"peak_acceleration_y":encode_uint8(e,4);break;case"rms_velocity_z":encode_uint8(e,5);break;case"peak_acceleration_z":encode_uint8(e,6);break;case"off":encode_uint8(e,0);break;default:throw new Error("mode is outside of specification: "+n)}}function encode_calculation_trigger(e,n){var o=0;if("boolean"!=typeof n.on_event||"boolean"!=typeof n.on_threshold||"boolean"!=typeof n.on_button_press)throw new Error("calculation_trigger must contain: on_event, on_threshold and on_button_press boolean fields");o|=n.on_event?1:0,o|=n.on_threshold?2:0,encode_uint8(e,o|=n.on_button_press?4:0)}function encode_fft_trigger_threshold(e,n,o,c){var _;switch(n){case"velocity":_=0;break;case"acceleration":_=1;break;default:throw new Error("Invalid unit")}_|=(32767&o)<<1,encode_uint32(e,_|=(100*c&65535)<<16)}function encode_fft_selection(e,n){var o,c;switch(n.axis){case"x":o=0;break;case"y":o=1;break;case"z":o=2;break;default:throw new Error("selection.axis must one of 'x', 'y' or 'z'")}switch(n.resolution){case"low_res":c=0;break;case"high_res":c=1;break;default:throw new Error("selection.resolution must one of 'low_res' or 'high_res'")}if("boolean"!=typeof n.enable_hanning_window)throw new Error("selection.enable_hanning_window must be a boolean");var _=o;_|=c<<2,encode_uint8(e,_|=(n.enable_hanning_window?1:0)<<3)}function encode_frequency_range(e,n,o){var c=0;switch(n){case"range_1":c+=0;break;case"range_2":c+=1;break;default:throw new Error("Invalid velocity range!"+n)}switch(o){case"range_1":c+=0;break;case"range_2":c+=2;break;default:throw new Error("Invalid acceleration range!"+o)}encode_uint8(e,c)}function encode_base_config_switch(e,n){var o=0;n.enable_confirmed_event_message&&(o|=1),n.enable_confirmed_data_message&&(o|=4),n.allow_deactivation&&(o|=8),e.push(o&mask_byte)}function encode_base_config_switch_v3(e,n){var o=0;n.enable_confirmed_event_message&&(o|=1),n.enable_confirmed_data_message&&(o|=2),n.allow_deactivation&&(o|=4),n.enable_debug_info&&(o|=8),e.push(o&mask_byte)}function encode_sensor_config_switch_mask_v3(e,n){var o=0;switch(n.selection){case"extended":break;case"min_only":o|=1;break;case"max_only":o|=2;break;case"avg_only":o|=3;break;default:throw new Error("Out of bound, selection: "+n.selection)}e.push(o)}function encode_uint32(e,n){if(null==n)throw new Error("Variable undefined");e.push(n&mask_byte),e.push(n>>8&mask_byte),e.push(n>>16&mask_byte),e.push(n>>24&mask_byte)}function encode_int32(e,n){encode_uint32(e,n)}function encode_uint16(e,n){if(null==n)throw new Error("Variable undefined");e.push(n&mask_byte),e.push(n>>8&mask_byte)}function encode_int16(e,n){if(null==n)throw new Error("Variable undefined");encode_uint16(e,n)}function encode_uint8(e,n){if(null==n)throw new Error("Variable undefined");e.push(n&mask_byte)}function encode_int8(e,n){encode_uint8(e,n)}function encode_sci_6(e,n){if(null==n)throw new Error("Variable undefined");if(scale_power=Number(n.toExponential().split("e")[1]),scale_power<-2&&(scale_power=-2),1<scale_power&&(scale_power=1),scale_coefficient=n/Math.pow(10,scale_power),(scale_coefficient!=Math.floor(scale_coefficient)||scale_coefficient<1||15<scale_coefficient)&&(--scale_power,scale_coefficient=n/Math.pow(10,scale_power),scale_coefficient<1||15<scale_coefficient||scale_power<-2||1<scale_power))throw new Error("Out of bound, scale: "+scale_power+", coefficient: "+scale_coefficient);power=(scale_power+2&3)<<4,coefficient=15&scale_coefficient,e.push(coefficient|power)}function calc_crc(e){for(var n=function(){for(var e=0,n=new Array(256),o=0;256!=o;++o)e=1&(e=1&(e=1&(e=1&(e=1&(e=1&(e=1&(e=1&(e=o)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1)?-306674912^e>>>1:e>>>1,n[o]=e;return"undefined"!=typeof Int32Array?new Int32Array(n):n}(),o=-1,c=(e.length,0);c<e.length;)o=o>>>8^n[255&(o^e[c++])];return 65535&o}function encode_status_msg_delay_interval_v3(e,n,o){var c=0;switch(o){case"2 minutes":c=0;break;case"15 minutes":c=1;break;case"1 hour":c=2;break;case"4 hours":c=3;break;case"12 hours":c=4;break;case"1 day":c=5;break;case"2 days":c=6;break;case"5 days":c=7;break;default:throw new Error("status_message_interval is outside of specification: "+obj.status_message_interval)}n|=c<<5;e.push(n)}function encode_channel_plan_v3(e,n){switch(n){case"EU868":e.push(1);break;case"US915":e.push(2);break;case"CN779":e.push(3);break;case"EU433":e.push(4);break;case"AU915":e.push(5);break;case"CN470":e.push(6);break;case"AS923":e.push(7);break;case"AS923-2":e.push(8);break;case"AS923-3":e.push(9);break;case"KR920":e.push(10);break;case"IN865":e.push(11);break;case"RU864":e.push(12);break;case"AS923-4":e.push(13);break;default:throw new Error("channel_plan outside of specification: "+obj.channel_plan)}}function validate_frequency_span(e,n,o){var c="";if(0<e.start&&e.start>=e.stop&&(c=".start can not be equal to or higher than stop"),8192<e.stop*n&&(c=".stop * resolution.velocity cannot be higher than 8192"),""!=c)throw new Error("frequency.span."+o+c)}function lookup_config_type(e){switch(e){case"base":return 0;case"region":return 1;case"reserved":return 2;case"sensor":return 3;case"sensor_data":return 4;case"sensor_conditions":return 5;default:throw new Error("Unknown config_type: "+e)}}