## LoRa Communication

In this folder all documentation and scripts related to LoRa communication of the specific product can be found. 

### Protocol version

The protocol version depends on the production batch of your product. The communication protocol documents and examples apply to products of a certain batch. The batch can be read from the serial number. The encoder / decoder are compatible with all protocol versions.

The current page is for the latest version. Other versions can be found via the following table.

| Batch  | Serial number example  | Protocol version  |
|---|---|---:|
| DS-01 AA  | TT 01 20 **AA** 00001 | [TT protocol v2](legacy/protocol_v2) |
| DS-01 AB  | TT 01 21 **AB** 00001 | [TT protocol v3](legacy/protocol_v3) |
| DS-02 AA  | TT 02 22 **AA** 00001 | TT protocol v4 |

### Online configurator

The device is configurable over LoRaWAN. To help generate a configuration, our [NEON Configurator](https://neon-configurator.twtg.io/neon/tt/v3/) can be used. This configurator is an online form with all possible settings within their allowed ranges. After tailoring the settings to your application you can then generate a LoRaWAN message to be sent via your network server.

### Conversion

The sensor communicates over LoRaWAN using a binary protocol. Usally the binary protocol is converted at the LoRa network server to a easier to handle format: JSON.

- encoding: from JSON to a binary string for to the sensor
- decoding: from a binary string from the sensor to JSON

#### Encoder / decoder

This folder contains Javascript files can help with the conversion, for example in the LoRa network server. The scripts are known to be compatible with the following network servers:

- [ChirpStack](https://www.chirpstack.io/)
- [The Things Network](https://www.thethingsnetwork.org/)


The encoder/decoder script names are postfixed with version information: 

	[encoder/decoder]_[type]_rev-[rev].js

- **type**: the sensor type abbreviation
- **rev**: the revision number of improvements of the scripts


## Conversion examples

The examples below are generated using the Javascript files in the example folder using [nodejs](https://nodejs.org/) (a Linux application to execute Javascript files).

### Decoding TT protocol v4

Generated by:
```
nodejs ./examples/decoder-tt-examples.js
```

#### Boot message
fPort: 1
, bytestring (hexidecimal):
```
4001
```
JSON:
```
{
    "boot": {
        "reboot_reason": {
            "major": "config update",
            "minor": ""
        },
        "protocol_version": 4
    }
}
```
#### Activated message
fPort: 5
, bytestring (hexidecimal):
```
4004
```
JSON:
```
{
    "activated": {
        "device_type": "tt",
        "protocol_version": 4
    }
}
```
#### Deactivated message
fPort: 6
, bytestring (hexidecimal):
```
400000
```
JSON:
```
{
    "deactivated": {
        "reason": "user_triggered",
        "protocol_version": 4
    }
}
```
#### Application event message (pattern 1)
fPort: 3
, bytestring (hexidecimal):
```
40024a9cff
```
JSON:
```
{
    "sensor_event": {
        "selection": "max_only",
        "condition_0": 0,
        "condition_1": 1,
        "condition_2": 0,
        "condition_3": 1,
        "trigger": "periodic",
        "temperature": {
            "max": -10,
            "status": "OK"
        },
        "protocol_version": 4
    }
}
```
#### Application event message (pattern 2)
fPort: 3
, bytestring (hexidecimal):
```
40004a44489cffc800
```
JSON:
```
{
    "sensor_event": {
        "selection": "extended",
        "condition_0": 0,
        "condition_1": 1,
        "condition_2": 0,
        "condition_3": 1,
        "trigger": "periodic",
        "temperature": {
            "min": 1850,
            "max": -10,
            "avg": 20,
            "status": "OK"
        },
        "protocol_version": 4
    }
}
```
#### Device status message (pattern 1)
fPort: 2
, bytestring (hexidecimal):
```
407515030002060102
```
JSON:
```
{
    "device_status": {
        "battery_voltage": 2.9176470588235293,
        "temperature": 21,
        "lora_tx_counter": 3,
        "avg_rssi": "-100..-129",
        "bist": "0x06",
        "event_counter": 1,
        "sensor_type": "K",
        "protocol_version": 4
    }
}
```

### Encoding TT protocol v4

Generated by:
```
nodejs ./examples/encoder-tt-examples.js
```

#### Base config message
JSON:
```
{
    "config_update_req": {
        "config_type": "base",
        "protocol_version": 4,
        "tag": "0x096c4970",
        "payload": {
            "switch_mask": {
                "enable_confirmed_event_message": true,
                "enable_confirmed_data_message": true,
                "allow_deactivation": true
            },
            "periodic_message_random_delay_seconds": 31,
            "status_message_interval": "5 days"
        }
    }
}
```
Bytestring (hexidecimal):
```
4070496c0907ff
```
#### Sensor config message
JSON:
```
{
    "config_update_req": {
        "config_type": "sensor",
        "protocol_version": 4,
        "tag": "0xE85892DC",
        "payload": {
            "device_type": "tt",
            "sensor_type": "K",
            "switch_mask": {
                "selection": "avg_only"
            },
            "measurement_interval_minutes": 5,
            "periodic_event_message_interval": 12
        }
    }
}
```
Bytestring (hexidecimal):
```
43dc9258e8040203050c00
```
